import sys
from PyQt6.QtGui import QAction
from PyQt6.QtCore import Qt
from PyQt6.QtWidgets import (
    QApplication,
    QGridLayout,
    QLabel,
    QMainWindow,
    QWidget,
    QPushButton,
    QVBoxLayout,
    QLineEdit,
    QTabWidget,
    QListWidget,
    QMessageBox,
)


class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Kalkulator Sederhana")
        self.setGeometry(300, 300, 300, 300)

        # ====== TAB WIDGET ======
        self.tabs = QTabWidget()
        self.setCentralWidget(self.tabs)

        # Tab 1: Kalkulator
        self.calc_tab = QWidget()
        self.tabs.addTab(self.calc_tab, "Kalkulator")

        # Tab 2: Riwayat
        self.history_tab = QWidget()
        self.tabs.addTab(self.history_tab, "Riwayat")

        # ====== Output ======
        self.output = QLineEdit("0")
        self.output.setAlignment(Qt.AlignmentFlag.AlignRight)
        self.output.setReadOnly(True)
        self.output.setFixedHeight(50)

        # ====== Layout Tombol (4x4 Grid) ======
        grid = QGridLayout()

        # Baris 1
        self.cn = QPushButton("CN")
        self.bagi = QPushButton("/")
        self.multi = QPushButton("*")
        self.del_btn = QPushButton("DEL")

        # Baris 2
        self.six = QPushButton("6")
        self.eight = QPushButton("8")
        self.nine = QPushButton("9")
        self.min = QPushButton("-")

        # Baris 3
        self.two = QPushButton("2")
        self.three = QPushButton("3")
        self.four = QPushButton("4")
        self.add = QPushButton("+")

        # Baris 4
        self.one = QPushButton("1")
        self.zero = QPushButton("0")
        self.dot = QPushButton(".")
        self.equal = QPushButton("=")

        # Tambahkan tombol ke grid sesuai posisi
        grid.addWidget(self.cn, 0, 0)
        grid.addWidget(self.bagi, 0, 1)
        grid.addWidget(self.multi, 0, 2)
        grid.addWidget(self.del_btn, 0, 3)

        grid.addWidget(self.six, 1, 0)
        grid.addWidget(self.eight, 1, 1)
        grid.addWidget(self.nine, 1, 2)
        grid.addWidget(self.min, 1, 3)

        grid.addWidget(self.two, 2, 0)
        grid.addWidget(self.three, 2, 1)
        grid.addWidget(self.four, 2, 2)
        grid.addWidget(self.add, 2, 3)

        grid.addWidget(self.one, 3, 0)
        grid.addWidget(self.zero, 3, 1)
        grid.addWidget(self.dot, 3, 2)
        grid.addWidget(self.equal, 3, 3)

        # ====== Gabungkan ======
        layout = QVBoxLayout()
        layout.addWidget(self.output)
        layout.addLayout(grid)
        self.calc_tab.setLayout(layout)

        # ====== Riwayat ======
        self.history_list = QListWidget()
        layout_history = QVBoxLayout()
        layout_history.addWidget(QLabel("Riwayat Perhitungan:"))
        layout_history.addWidget(self.history_list)
        self.history_tab.setLayout(layout_history)

        # ====== Sinyal Tombol ======
        for tombol in (
            self.zero, self.one, self.two, self.three, self.four,
            self.six, self.eight, self.nine
        ):
            tombol.clicked.connect(self.pushBut)

        for op in (self.add, self.min, self.multi, self.bagi, self.dot):
            op.clicked.connect(self.pushBut)

        self.equal.clicked.connect(self.pushBut)
        self.cn.clicked.connect(self.clear_output)
        self.del_btn.clicked.connect(self.delete_last)

        # ====== Menu Bar ======
        self.create_menu()

    # ====== Menu ======
    def create_menu(self):
        menuBar = self.menuBar()
        file_menu = menuBar.addMenu("File")
        exit_action = QAction("Keluar", self)
        exit_action.triggered.connect(self.close)
        file_menu.addAction(exit_action)

    # ====== Logika Kalkulator ======
    def pushBut(self):
        operan = ["+", "-", "*", "/"]
        angka = "98643210"
        btn = self.sender()
        if not btn:
            return
        text = btn.text()
        front = self.output.text()

        if self.output.text() == "0" and text in angka:
            self.output.setText(text)
            return
        if text in operan:
            if self.output.text() == "0" and text == "-":
                self.output.setText("-")
            elif front and front[-1] in operan:
                self.output.setText(front[:-1] + text)
            else:
                self.output.setText(front + text)
            return
        if text == "=":
            hasil = self.count(front)
            if hasil is None:
                self.output.setText("Err")
            else:
                self.output.setText(str(hasil))
                self.history_list.addItem(f"{front} = {hasil}")
            return
        self.output.setText(front + text)

    def count(self, expr: str):
        try:
            return eval(expr, {"__builtins__": None}, {})
        except Exception:
            return None

    def clear_output(self):
        self.output.setText("0")

    def delete_last(self):
        teks = self.output.text()
        if len(teks) > 1:
            self.output.setText(teks[:-1])
        else:
            self.output.setText("0")


if __name__ == "__main__":
    app = QApplication(sys.argv)
    win = MainWindow()
    win.show()
    sys.exit(app.exec())